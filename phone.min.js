#!/usr/bin/node

baseurl 		= 'http://10.10.2.213'
host 			= '10.10.2.213'
url_get_sessionid 	= "/servlet?p=login&q=getsessionid"
url_login 		= "/servlet?p=login&q=login"
url_switch		= "/servlet?p=account-assignment&q=write"
url_getsettings		= "/servlet?p=account-assignment&q=load"
jsrsasign 		= require('jsrsasign')
CryptoJS 		= require('crypto-js')
rsa 			= new jsrsasign.RSAKey()
username 		= 'admin'
password 		= 'admin'


var http 		= require('http');
var querystring 	= require('querystring')
post_data 		= { }

jsessionid = "dummycookie"

//<input name="token" type="hidden" value="2127985523">

switch1_postdata = "IncomingHandset1=0&IncomingHandset3=1&IncomingHandset4=1&IncomingHandset5=1&OutgoingHandset1=0&HandsetOutGoingLine=2&HandsetOutGoingLine=2&OutgoingHandset3=1&HandsetOutGoingLine=3&OutgoingHandset4=1&HandsetOutGoingLine=4&OutgoingHandset5=1&HandsetOutGoingLine=5&incominglines=2&incominglines=&incominglines=3&incominglines=4&incominglines=5&incominglines=&outgoinglines=2&outgoinglines=&outgoinglines=3&outgoinglines=4&outgoinglines=5&outgoinglines=&btnSubmit=%D0%A1%D0%BE%D1%85%D1%80%D0%B0%D0%BD%D0%B8%D1%82%D1%8C&token="
switch2_postdata = "IncomingHandset1=0&IncomingHandset3=1&IncomingHandset4=1&IncomingHandset5=1&OutgoingHandset1=0&HandsetOutGoingLine=1&HandsetOutGoingLine=2&OutgoingHandset3=1&HandsetOutGoingLine=3&OutgoingHandset4=1&HandsetOutGoingLine=4&OutgoingHandset5=1&HandsetOutGoingLine=5&incominglines=1&incominglines=&incominglines=3&incominglines=4&incominglines=5&incominglines=&outgoinglines=1&outgoinglines=&outgoinglines=3&outgoinglines=4&outgoinglines=5&outgoinglines=&btnSubmit=%D0%A1%D0%BE%D1%85%D1%80%D0%B0%D0%BD%D0%B8%D1%82%D1%8C&token="


//GET /servlet?p=account-assignment&q=load HTTP/1.1
//Host: 10.10.2.213
//User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:87.0) Gecko/20100101 Firefox/87.0
//Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
//Accept-Language: ru,en-US;q=0.7,en;q=0.3
//Accept-Encoding: gzip, deflate
//Referer: http://10.10.2.213/servlet?p=login&q=loginForm&jumpto=account-assignment
//DNT: 1
//Connection: keep-alive
//Cookie: JSESSIONID=13d3a8906043a1910
//Upgrade-Insecure-Requests: 1
//Cache-Control: max-age=0


//POST /servlet?p=account-assignment&q=write HTTP/1.1
//Host: 10.10.2.213
//User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:87.0) Gecko/20100101 Firefox/87.0
//Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
//Accept-Language: ru,en-US;q=0.7,en;q=0.3
//Accept-Encoding: gzip, deflate
//Content-Type: application/x-www-form-urlencoded
//Content-Length: 531
//Origin: http://10.10.2.213
//DNT: 1
//Connection: keep-alive
//Referer: http://10.10.2.213/servlet?p=account-assignment&q=load
//Cookie: JSESSIONID=14577090179997638
//Upgrade-Insecure-Requests: 1
//
req_session = {
  host: '10.10.2.213',
  path: url_get_sessionid,
};

req_getsettings = {
  host: '10.10.2.213',
  path: url_getsettings,
  headers: {
	'Cookie':"",
  }
};

req_login = {
  host: '10.10.2.213',
  path: url_login,
  method: "POST",
  headers: {
	'Cookie':"",
	'Content-Type': 'application/x-www-form-urlencoded',
  }
};

req_switch = {
  host: '10.10.2.213',
  path: url_switch,
  method: "POST",
  headers: {
	'Cookie':"",
	'Content-Type': 'application/x-www-form-urlencoded',
  }
};

callback_getsettings = function(response) {
  	var str = '';
  	response.on('data', function (chunk) { str += chunk; });
  	response.on('end', function () {
	console.log("\nCALLBACK GETSETTINGS",response.statusCode,response.statusMessage)
	switch1_postdata += str.match(/UpdateToken..(\d+)/)[1]
	switch2_postdata += str.match(/UpdateToken..(\d+)/)[1]

  	req_switch.headers['Content-Length']=Buffer.byteLength(switch1_postdata,'utf8')
  	req_switch.headers['Cookie']="JSESSIONID="+jsessionid

	switch_req = http.request(req_switch,callback_switch)
	console.log('headers:\n\t',switch_req.getHeaders())
	switch_req.write(switch1_postdata)
	console.log('post data:\n\t',switch1_postdata)
	switch_req.end()
  });
}

callback_login = function(response) {
  	var str = '';
  	response.on('data', function (chunk) { str += chunk; });
  	response.on('end', function () {
	console.log("\nCALLBACK LOGIN",response.statusCode,response.statusMessage)
  	req_getsettings.headers['Cookie']="JSESSIONID="+jsessionid
	http.request(req_getsettings,callback_getsettings).end()

  });
}

callback_switch = function(response) {
	console.log("\nCALLBACK SWITCH")
  	var str = '';
  	response.on('data', function (chunk) { console.log('10'); str += chunk; });
  	response.on('end', function () {
	console.log("\nCALLBACK SWITCH",response.statusCode,response.statusMessage)
  });
}

callback_get_session = function(response) {
  	var str = '';
  	response.on('data', function (chunk) { str += chunk; });
  	response.on('end', function () {
  	var n,e
  	params = str.split(',');
  	n = params[0]
  	e = params[1]
  	jsessionid = params[2]
//	console.log('n (raw):\n\t',n)
//	console.log('e (raw):\n\t',e)
//	console.log('jsession: (raw)\n\t',jsessionid)
  	req_login.headers['Cookie']="JSESSIONID="+jsessionid
	rsa.setPublic(n,e);


	key = CryptoJS.MD5(Math.random().toString()).toString()
//        console.log('key',key)
	key_encrypt = rsa.encrypt(key);
//       console.log('key_rsa',key_encrypt)
  	key_bytes = CryptoJS.enc.Hex.parse(key)


	iv = CryptoJS.MD5(Math.random().toString()).toString()
//      console.log('iv',key)
	iv_encrypt = rsa.encrypt(iv);
//     console.log('iv_rsa',iv_encrypt)
  	iv_bytes = CryptoJS.enc.Hex.parse(iv)

  	data = "rand="+Math.random()+';'
	  +"sessionid="+jsessionid+';'
	  +"username="+username+';'
	  +"pwd="+password+';'
  	data = "MD5="+CryptoJS.MD5(data)+';'+data;
//	console.log(data)

  	encrypted = CryptoJS.AES.encrypt(data, key_bytes, {iv:iv_bytes, mode: CryptoJS.mode.CBC, padding:CryptoJS.pad.ZeroPadding });
//  	console.log('enc',encrypted.toString())
        value = encrypted.toString();

	post_data.key = key_encrypt
	post_data.iv = iv_encrypt
	post_data.data = value
	post_data.jumpto = 'status'
	post_data.acc = ''

        post_data = querystring.stringify(post_data)
	
  	req_login.headers['Content-Length']=Buffer.byteLength(post_data,'utf8')
	login_req = http.request(req_login,callback_login)
//	console.log('headers:\n\t',login_req.getHeaders())
	login_req.write(post_data)
//	console.log('post data:\n\t',post_data)
	login_req.end()
  });
}

http.request(req_session, callback_get_session).end()

